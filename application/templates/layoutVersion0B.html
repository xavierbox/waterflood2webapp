<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Main Layout Component</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <!-- Add Plotly CDN -->
     <script src='https://cdn.plot.ly/plotly-3.0.0.min.js'></script>
     <!--script src = "components.js"></script-->
     <!--script src= "app_components.js"></script-->

     <script src="{{ url_for('static', filename='globals.js') }}"></script>
     <script src="{{ url_for('static', filename='components.js') }}"></script>
     <script src="{{ url_for('static', filename='app_components.js') }}"></script>
     <script src="{{ url_for('static', filename='support.js') }}"></script>
     <script src="{{ url_for('static', filename='locs_chart_support.js') }}"></script>
     
     <link href ="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">

     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

</head>




<body>
    <script>function Id(id){return document.getElementById(id)}</script>

    <!-- floating well-detail-dialog -->
    <div id="dell-detail-dialog" class="dell-detail-dialog-panel">
        <div class="dell-detail-dialog-close" onclick="closeWellDetailDialog()">âœ–</div>
        <div id="dell-detail-dialog-header" class="dell-detail-dialog-header">WELL NAME</div>
    
      
        <div style='min-height:400px; height:400px' id="dell-detail-dialog-chart" class="dell-detail-dialog-chart"></div>
        <span class="subtitle">Closest neighbours</span>
        <table class="dell-detail-dialog-table">
          <thead>
            <tr>
              <th>Well</th>
              <th>Distance</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="dell-detail-dialog-table-body"></tbody>
        </table>
        <!-- Sector: 3<br>
        Reservoir: Wara<br>
        RMU: LW<br> -->
        <hr>
        <button class="well-detail-dialog-close-button btn btn-danger" onclick="closeWellDetailDialog()">Close</button>
        
    </div>
  


    <!-- spinning indicator of a long operation -->
    <div id="loading" class="loader hidden"><div class="spinner"></div>Loading...</div>
    <script>function toggleLoading(show) {
        let message = document.getElementById("loading");//.style.display = show ? "block" : "none";

        if (show) {
            message.classList.remove('hidden');// .style.display = "block"; // Show message
        } else {
            message.classList.add('hidden');// .style.display = "none"; // Hide message
        }
      

    }</script>
  

    <div id='projects-component-container' class="hidden pane projects-component-container">

   
        <div class="projects-component-left">
            <h1 style="font-size: 46px;">Waterflood Insights</h1>
            <h2>Open project</h2>
        </div>
    
        <div class="projects-component-divider"></div>
    
        <div class="projects-component-right">
            <project-list-component id="project-list-component"></project-list-component> <!-- Custom Component -->
        </div>
    </div>


    <div id="top-right-pagination">
        <ul class="pagination">
          <li class="page-item">
            <a id='field-tab-button' class="field-tab btn-sm page-link">Field</a>
          </li>

          <li class="page-item">
            <a id='sector-tab-button' class="field-tab btn-sm  page-link">Sector </a>
          </li>
          <li class="page-item">
            <a id='wells-tab-button'class="field-tab btn-sm page-link">Wells</a>
          </li>
          <li class="page-item">
            <a id='workflows-tab-button'class="field-tab btn-sm page-link">Workflows</a>
          </li>
        </ul>
        <script>
            let tabs = document.querySelectorAll('.field-tab');
            tabs.forEach((tab) => {
                tab.addEventListener('click', function(){
                    tabs.forEach((t) => {
                        t.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        </script>
     
        <div id="field-charts-container" class="field-chart-container">
        <p>Field charts go here...</p></div>
        <div id="sector-charts-container" class="field-chart-container">
        <p>Sector charts go here...</p></div>
        <div id="wells-charts-container" class="field-chart-container">
        <p>Wells charts go here...</p></div>        
        <div id="workflows-charts-container" class="field-chart-container">
            <p>workflows go here...</p></div>        
    

        <script>
            let items = document.querySelectorAll('.field-tab');
            items.forEach((item) => {
                item.addEventListener('click', function(){
                    
                    let tabs = document.querySelectorAll('.field-chart-container'); 
                    tabs.forEach((tab) => {
                        tab.classList.add('hidden');// .style.display = 'none';
                    });
                    let tab_id = this.id.split('-')[0]+'-charts-container';
                    document.getElementById(tab_id).classList.remove('hidden');// .style.display = 'block';
                    

                });
            }); 
        </script>
    </div>

    <div id='side-bar-top' class="h50  p-3">
          
        <button id='data-tab1' class="btn btn-sm" onclick="showCard('data-selection-card',this)">Data</button>
        <button class="btn btn-sm" onclick="showCard('studies-selector-card',this)">Studies</button>
        <button class="btn btn-sm" onclick="showCard('views-selector-card',this)">Views</button>
        <!--button class="btn btn-sm" onclick="showCard('workflows-selector-card',this)">Workflows</button-->


        <div class="card" id="data-selection-card">
            <div>
                <p class="subtitle">Reservoir management unit</p>
                <combobox-component id="reservoir-unit-selector"></combobox-component>
            </div>
            <div>
   
                <details><summary style="font-weight: bold;font-size: 1.1em;">Sectors</summary>
                <two-column-checkbox-list id="sector-selector"></two-column-checkbox-list>
               </details>
            </div>
            <div>
                <p class="subtitle">Time frame</p>
                <label for="start-date" class="form-label">Start:</label>
                <input type="date" id="start-date" name="start-date" class="form-control mb-2">
                <label for="end-date" class="form-label">End:</label>
                <input type="date" id="end-date" name="end-date" class="form-control">
        
                <double-range-component></double-range-component>
                <p></p>
                Displace time frame and load data 
                <div class="d-flex align-items-center gap-2">
                    
                    <button class="btn btn-primary" id="time-frame-player-left-button">
                        <i class="fas fa-caret-left"></i>
                    </button>
                    <input type="number" id="range-value" name="range-value" class="form-control text-center" min="1" max="180" value="1" style="width: 80px;">
                    <button class="btn btn-primary" id="time-frame-player-right-button">
                        <i class="fas fa-caret-right"></i>
                    </button>
                </div>
        
            </div>
            <hr>
            <button id='apply-data-selection-button' class="btn btn-primary">Apply</button>        
        </div>

        <div class="card" id="studies-selector-card">
            <stringlist-component  
            checkboxes=true 
            selection_mode='single' 
            id='study-selector'>
        </stringlist-component>
            <button id='study-selector-button' class="btn btn-primary">Load</button>
        </div> 
     
        <div class="card" id="views-selector-card">
            <span>Text on charts <input type="checkbox" id="display-text-on-chart-button" name="display-option" value="text"></span>
            <script>Id('display-text-on-chart-button').addEventListener('click',(evt)=>{

                //let text_on_charts = evt.target.checked;
                //alert('changed',  text_on_charts);
            });</script>
        </div>
          

    </div>

    <div id='side-bar-bottom'  class="h50 p-3" astyle="top: 50%;">
        
        <p class="subtitle">Workflows</p>
        <div class="card" id="workflows-selector-card">
            <stringlist-component id='workflow-selector' checkboxes=true 
            notitle='Workflows' selection_mode='single'> 
            </stringlist-component>
        </div>
    </div>

    <!-- Sticky Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">

            <button id="debug-stuff1">Fetch data for CRM modelling</button>

            <div class="container-fluid">
                <a class="navbar-brand" href="#">Waterflood insights</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
    
          
         
    
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a id='initialize-app-button'class="nav-link active" aria-current="page">Initialize</a>
                        </li>

                      
                    </ul>
 
                    <button style='float:right' id="projects-list-button">Projects</button>
             
                    <button style='float:right' id="check">Debug</button>
                    <script>
                        Id('check').addEventListener('click', function(){
            
              
            
                            alert('clicked');
                            let extra_stuff = Id('extra-stuff');
                            let field_stuff = Id('field-stuff');
                            
                            if(extra_stuff.classList.contains('hidden')){
                                extra_stuff.classList.remove('hidden');
                                //field_stuff.classList.add('hidden');
                            }else{  
                                extra_stuff.classList.add('hidden');
                                //field_stuff.classList.remove('hidden');
                            }
                                
                        });
                    </script>
    
                    <button style='aamargin-left:20%'class="warning-button" 
                    id="well-selection-indicator">
                        <span class="warning-icon">&#9888;
                          Well selection active
                        </span>
                      </button>
                </div>
    
      
    
          
    
            </div>
    
    
    
          
    
    </nav>


    <div id='all-app-wrapper' class="container-fluid hidden">


    <div style="position: relative;top: 57px;" >
        <div class="row">
                <!--div class="col-2" style="background-color: black; 4height: 100vh;">
                    Left menu
                </div-->

            <div id='field-stuff' class="col-12">
            <three-column-main-layout id = "main-layout"></three-column-main-layout>
            </div>

            <div id='extaara-stuff' class="col-12 hidden" style="height: 100vh;">
                <div id = "extra-layout">  I am hidden </div>
            </div>
    

            <div id='extra-stuff'  class="col-12 hidden row bg-primary" style="height:calc(100vh - 57px);">
                <tabs-component id="bottom-tabs"></tabs-component>
                <script>
                    Id('bottom-tabs').addNewTab('tab1', 'sdfgsdgdfg');
                    Id('bottom-tabs').addNewTab('tab2', 'sdfgsdgdfg');
                    Id('bottom-tabs').addNewTab('tab3', 'sdfgsdgdfg');
                    
                </script>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p> 
            </div>
            
        </div>
    </div>

    </div>
    
 

 

<script id="initialize-app">

    let layout = Id('main-layout');
    let project_description; 

    function Id( id ) { return document.getElementById(id); }    
  
    function load_empty_app(){
        
        layout.set('left-top',Id('side-bar-top'));
        layout.set('left-bottom',Id('side-bar-bottom'));
        layout.set('right-top',Id('top-right-pagination'));
     
        Id('data-tab1').click()
        Id('field-tab-button').click()
        
        iurl = 'get_list_of_projects';
        get_server(iurl, 'GET' )
            .then( (resp) =>{
                console.log('get_list_of_projects returned', resp);
                let projects = resp.data['projects'];
                let project_list = Id('project-list-component');
                project_list.projects = projects;
            })
            .then( ()=>{
                display_projects_page(true);
            } )
            .catch ((error) =>{
                console.log(error);
            });
    
    
    //document.querySelector('.projects-component-button btn btn-primary').click();

    }



    
    function load_project( project_name){
    
        return new Promise((resolve, reject) => {
            let iurl = 'get_project_description'
            let message = JSON.stringify( {project_name:project_name} )

            get_server(iurl, 'GET', message )
            .then( (resp) =>{
            console.log('get_project_description returned', resp);
            project_description = resp.data;
            resolve(resp.data);
            })
        .catch ((error) =>{
            console.log(error);
            });
        });
    }
 

    let resizePending = false;
    window.addEventListener('resize', () => {resizePending = true;});
    layout.addEventListener('pane-resized', () => {resizePending = true;});
    window.addEventListener('mouseup', () => { 
        
        console.log('mouseup...', resizePending);
        if(resizePending == true){
        
            let containers = document.querySelectorAll('.field-chart-container');
            containers.forEach((container) => {

                console.log('container:', container.offsetWidth, container.offsetHeight);
                let parent = container.parentElement;
                console.log('parent container:', parent.id,parent.offsetWidth, parent.offsetHeight);
                

                let plots = container.querySelectorAll('.js-plotly-plot');
                if(plots != null){
                    
                    for(let plt of plots){
                    try{
                    const layout = plt.layout;
                    console.log('layout', layout);
                    layout['width'] = parent.offsetWidth;
                    layout['autosize'] = true;
                    Plotly.Plots.resize(plt);
                    }catch(e){
                        console.log('Error resizing plot:', e);
                    }}

                }
            }); 

            resizePending = false;
        }
    });
  


    /*let app_layout = Id('main-layout');
    app_layout.addEventListener('pane-resized', (evt)=>
    {
        console.log( evt.detail );
    });*/

    

</script>
   
<script id='ui_events'>

    function display_projects_page( value ){

        if(value == true){
            Id('projects-component-container').classList.remove('hidden');
            Id('all-app-wrapper').classList.add('hidden');
        }
        else{
            Id('projects-component-container').classList.add('hidden');
            Id('all-app-wrapper').classList.remove('hidden');
        }
    }

    function load_and_display_study(study_name){

        console.log('loading and displaying a study named ', study_name);
        toggleLoading(true);
        setTimeout(()=>{
            toggleLoading(false);
        }, 2000);
        

    }

    async function get_charts_data(read_data){

        try{
            toggleLoading(true);

            const resp1 = await get_server('get_locations_chart','POST', JSON.stringify(read_data))
            populate_locations_plot(resp1.data);
            all_well_names_visible = resp1.data['all_names'];
            
            const resp2 = await get_server('get_field_charts','POST', JSON.stringify(read_data))
            populate_field_plots(resp2.data);
                
            const resp3 = await get_server('get_field_wells','POST', JSON.stringify(read_data))
            populate_field_wells_snapshot(resp3.data);


            const resp4 = await get_server('get_field_wells','POST', JSON.stringify(read_data))
            toggleLoading(false);

            //const resp5= await  get_server('get_wells_data','POST', JSON.stringify(read_data))
            //all_well_distances = resp5.all_well_distances;

            
            
        }


        catch (error){
                console.log(error);
                toggleLoading(false);
                alert('Error getting data for basic plots');
            }; 

    }
    /*when the user double-clicks in one workflow item*/
    Id('workflow-selector').addEventListener('dclicked',(evt)=>{
        //console.log('Workflow double-clicked:', evt.detail);
        console.log('workflow name double-clicked:', evt.detail.cell_text);
        if( evt.detail.cell_text.toLowerCase() != 'liquid history match')
        {
            Swal.fire({
            title: "Sorry...not implemented yet",
            html: "Only a few (maybe just one) workflow can be trigerred at the moment", 
            icon: "info"
            });

        }
        else{

            let read_data = get_project_data_selection();
            let result  = validateProjectDataSelection( read_data );
            if( isEmptyOrWhitespace(result) == false){
                Swal.fire({title: "Error data selection",html: result.replaceAll("\n", "<br>"),icon: "error"});
                return
            }

           
            toggleLoading(true);
            get_server('get_crm_input_data','POST',JSON.stringify(read_data))
                .then( (resp) =>{

                console.log('data received from server', resp );//distances_data);
                /*Example of data received from the server
                {
                    "dates": [
                        "2023-01-01",
                        "2023-02-01",
                        "2023-03-01",
                        "2023-04-01",
                        "2023-05-01",

                    ],
                    "distances": [
                        {
                            "distance": 26724.086917357108,
                            "injector": "BG-0604-1_I",
                            "producer": "AH-0191-2_P"
                        },
                            "distance": 3278.951071158391,
                            "injector": "BG-0757-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 4096.706186426527,
                            "injector": "BG-0758-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 6207.797163274271,
                            "injector": "BG-0759-1_I",
                            "producer": "BG-1766-2_P"
                        },

                            "distance": 3497.938905346225,
                            "injector": "BG-0604-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 5340.539927885718,
                            "injector": "BG-0721-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 4398.491484930774,
                            "injector": "BG-0722-1_I",
                            "producer": "BG-2203-1_P"
                        },
                    ],
                    "liquid_production": {
                        "data": {
                            "AH-0191-2_P": [
                                407.61655,
                                450.985,
                                451.67915,
                                456.0019
                
                            ],
                            "BG-0052-6_P": [
                                0,
                                1431.2434999999996,
                                2778.53845,
                                2907.1412
                            ],
                            "BG-0234-1_P": [
                                289.47475,
                                310.58589999999987,
                                306.7277,
                                300.5669000000001,
                                326.1468,
                                341.34515
                            ]  
                        },
                        "dates": [
                            "2023-01-01",
                            "2023-02-01"
                        ]
                    },

                    "water_injection": .... ther same 
                }
                */

                let rates = {
                    liquid_production: resp['liquid_production'],
                    water_injection: resp['water_injection'],
                    dates :resp['dates']
                }

                let component = new CRMSetupElement();//crm-setup-element
                Id('workflows-charts-container').innerHTML = '';
                Id('workflows-charts-container').classList.remove('hidden');
                Id('workflows-charts-container').appendChild(component);
                Id('workflows-tab-button').click();

                component.setData( resp['distances'], rates )

                component.addEventListener('close-clicked', ()=>{
                    Id('workflows-charts-container').innerHTML = '';
                    Id('workflows-charts-container').classList.add('hidden');
                    
                    Id('field-tab-button').click();
                });



                toggleLoading(false);
                })
                .catch( (error) =>{

                    console.log(error)
                    toggleLoading(false);
                });


        }

        /*let w = new CRMSetupElement();//crm-setup-element
        Id('workflows-charts-container').innerHTML = '';
        Id('workflows-charts-container').appendChild(w);
        Id('workflows-tab-button').click();



        */
    });

    /* Trigerred when the user clicks on a study in the list.*/
    Id('study-selector-button').addEventListener('click',(evt)=>{

        //the study name is fetched from the list 
        let study_name = Id('study-selector').selected()[0]['cell_text'];
        console.log('**Study name clicked:', study_name);

        load_and_display_study(study_name);
    });

    /*When the user selects a project in the projects list page*/
    Id('project-list-component').addEventListener('clicked', event => {
        console.log("Project clicked:", event.detail.projectName);
        //alert(`Opening project: ${event.detail.projectName}`);


        toggleLoading(true);
        load_project(event.detail.projectName).then( (data)=>{

            populate_project_description(data);
            display_projects_page(false);
            Id('field-tab-button').click()
            Id('data-tab1').click();
            toggleLoading(false);
        })
        .catch ((error) =>{
            console.log(error);
            toggleLoading(false);
        });
        ;
    });

    //navbar debug button
    Id('projects-list-button').addEventListener('click', function(){
        display_projects_page(true);
    });
    
    /* Trigerred when the user clicks "Apply" data selection in the left-top sidebar */
    Id('apply-data-selection-button').addEventListener('click', function(){
        
        let read_data = get_project_data_selection();
        let result  = validateProjectDataSelection( read_data );
        if( isEmptyOrWhitespace(result) == false){
            
            Swal.fire({
            title: "Error in selection",
            html: result.replaceAll("\n", "<br>"), 
            icon: "error"
             });
            return
        }
        if(read_data!=undefined){

            get_charts_data( read_data );
        }



        /* old version working smoothly 
        if(read_data!=undefined){

            toggleLoading(true);
            get_server('get_locations_chart','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                populate_locations_plot(resp.data);
                toggleLoading(false);
                all_well_names_visible = resp.data['all_names'];

            })  
            .catch ((error) =>{
                console.log(error);alert('Error getting data for locations');
                toggleLoading(false);
            }); 
            
            get_server('get_field_charts','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                console.log('get_field_charts returned', resp);
                populate_field_plots(resp.data);
            })
            .catch ((error) =>{
                console.log(error);alert('Error getting data for field data');
            }); 

            
            ////////////////
            get_server('get_field_wells','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                console.log('get_field_wells_snapshot returned', resp);
                populate_field_wells_snapshot(resp.data);

                //dummy();
            })
            .catch ((error) =>{
                console.log(error);alert('Error getting data for field data');
            }); 
        }*/
    }); 

    Id('debug-stuff1').addEventListener('click', (evt)=>{

        /*marking stuff in the locations chart*/
        let names = ['BG-1114-1_I','BG-1096-2_P'];
        let app_layout = Id('main-layout');
        let where = locations_chart_pane;
        let locs_container = app_layout.get_pane(where);// Id('locs-chart');
       

        highlightWellsInLocationsChart( locs_container, names, 'Highlighted' );
  
        return 


















        function formatString(str) {
            if (!str) return '';
            const noUnderscores = str.replace(/_/g, ' ');
            return noUnderscores.charAt(0).toUpperCase() + noUnderscores.slice(1);
            }

        console.log('debug-stuff1 clicked');
        toggleLoading(true);

        //get the filters. Zone, subzone, wells_selected if any.
        //time slice. 
        let read_data = get_project_data_selection();
            
        //if we dont have a precise selection, then send all that are visuble 
        if( (read_data['name'].length == 0 ) || (read_data['name'] == undefined)) {
            read_data['name'] = all_well_names_visible;
        }


            

            
            get_server('get_crm_input_data','POST',JSON.stringify(read_data))
            .then( (resp) =>{
                
                console.log('get_crm_input_data returned');
                let crm_component = document.querySelector('crm-setup-element');
                let distances_data = resp['distances'];
                console.log('data received from server', resp );//distances_data);
                /*Example of data received from the server
                {
                    "dates": [
                        "2023-01-01",
                        "2023-02-01",
                        "2023-03-01",
                        "2023-04-01",
                        "2023-05-01",

                    ],
                    "distances": [
                        {
                            "distance": 26724.086917357108,
                            "injector": "BG-0604-1_I",
                            "producer": "AH-0191-2_P"
                        },
                            "distance": 3278.951071158391,
                            "injector": "BG-0757-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 4096.706186426527,
                            "injector": "BG-0758-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 6207.797163274271,
                            "injector": "BG-0759-1_I",
                            "producer": "BG-1766-2_P"
                        },

                            "distance": 3497.938905346225,
                            "injector": "BG-0604-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 5340.539927885718,
                            "injector": "BG-0721-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 4398.491484930774,
                            "injector": "BG-0722-1_I",
                            "producer": "BG-2203-1_P"
                        },
                    ],
                    "liquid_production": {
                        "data": {
                            "AH-0191-2_P": [
                                407.61655,
                                450.985,
                                451.67915,
                                456.0019
                
                            ],
                            "BG-0052-6_P": [
                                0,
                                1431.2434999999996,
                                2778.53845,
                                2907.1412
                            ],
                            "BG-0234-1_P": [
                                289.47475,
                                310.58589999999987,
                                306.7277,
                                300.5669000000001,
                                326.1468,
                                341.34515
                            ]  
                        },
                        "dates": [
                            "2023-01-01",
                            "2023-02-01"
                        ]
                    },

                    "water_injection": .... ther same 
                }
                */

                let n = -1
                let keys = ['liquid_production','water_injection']
                let containers = [ Id('liquid-production-rates-container'), Id('water-injection-rates-container')]
                for(let key of keys){
                    n = n + 1 
                    
                    let rates = resp[key]['data']
                    let dates =  resp[key]['dates']
                    const traces = [];
                    for (const well in rates) {
                    traces.push({
                        //works extra_stuff: dates, 
                        x: dates, y: rates[well], mode: 'lines', name: well,
                        type: 'scatter'
                    });
                    }

                    series_name = formatString( key )
                    let chart = containers[n];
                    chart.innerHTML = "";
                    Plotly.newPlot( chart, traces, {
                    title: {'text':series_name, font: {size:20}},
                    xaxis: { text: 'Date' },yaxis: { text: 'Value' }}, {'responsive': true});
                }

                


                //crm_component.setData( distances_data, resp['rates']);
                //let pairs = crm_component.extractPairs( 750 );
                //crm_component.setData( data['distances'], data['rates'] );
                //crm_component.extractPairs( 1750 );

                toggleLoading(false);
            })  
            .catch( (err) => {

                console.log('error', err);
                toggleLoading(false);
            });
         

    });

    Id('time-frame-player-left-button').addEventListener('click', (evt)=>{
    
        moveDates(-1);
        Id('apply-data-selection-button').click();
    });

    Id('time-frame-player-right-button').addEventListener('click', (evt)=>{
        moveDates(1);
        Id('apply-data-selection-button').click();
    });
    


</script>

<script id="load-empty-app">

    
    window.onload = function() {
        load_empty_app();
    };





</script>


<script id="floating-well-dialog-stuff">
    function openWellDetailDialog(wellName, chartData, tableData) {
      const dialog = document.getElementById("dell-detail-dialog");
      dialog.style.display = "flex";
  
      document.getElementById("dell-detail-dialog-header").textContent = wellName;
  
      Plotly.newPlot("dell-detail-dialog-chart", chartData, {
        margin: { t: 20 },
        responsive: true
      });
  
      const tbody = document.getElementById("dell-detail-dialog-table-body");
      tbody.innerHTML = "";
      tableData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.well}</td><td>${row.distance}</td><td>${row.type}</td>`;
        tbody.appendChild(tr);
      });
    }
  
    function closeWellDetailDialog() {
      document.getElementById("dell-detail-dialog").style.display = "none";
    }
  
    function showSampleDialog( well_details ) {
      const sampleChartData = [{
        x: ['2024-01', '2024-02', '2024-03', '2024-04'],
        y: [100, 120, 110, 130],
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Production'
      }];
  
      const sampleTableData = [
        { well: 'INJ-001', distance: 145, type: 'Injector' },
        { well: 'INJ-002', distance: 180, type: 'Injector' },
        { well: 'OBS-001', distance: 90, type: 'Observer' }
      ];
  
      openWellDetailDialog('WELL-ABC-101', sampleChartData, sampleTableData);
    }
  
    // Make the dialog draggable
    const dialog = document.getElementById("dell-detail-dialog");
    const header = document.getElementById("dell-detail-dialog-header");
    let offsetX = 0, offsetY = 0, isDragging = false;
  
    header.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - dialog.offsetLeft;
      offsetY = e.clientY - dialog.offsetTop;
      document.body.style.userSelect = 'none';
    });
  
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        dialog.style.left = `${e.clientX - offsetX}px`;
        dialog.style.top = `${e.clientY - offsetY}px`;
      }
    });
  
    document.addEventListener('mouseup', () => {
      isDragging = false;
      document.body.style.userSelect = '';
    });
</script>


<script id="window-controller">


    /*chart-exchange*/
    window.addEventListener('wells-names-selected-in-scatter-chart', (evt)=>{
        console.log('MAIN app: wells-names-selected-in-scatter-chart', evt.detail);
        let names = evt.detail.names;
        let key = 'Highlighted';
        
        let app_layout = Id('main-layout');
        let where = locations_chart_pane;
        let locs_container = app_layout.get_pane(where);
        highlightWellsInLocationsChart( locs_container, names, key );
    })

    /*chart-exchange*/
    window.addEventListener('wells-names-selected-in-locs-chart', (evt)=>{


      /*Delete the traces added sometime before.*/
      function deleteTracesInLegendGroup(plotDiv, legendGroup) {
            let tracesToDelete = [];
            plotDiv.data.forEach((trace, index) => {
                if (trace.legendgroup == legendGroup){
                    tracesToDelete.push(index);
                }
            });
            if(tracesToDelete.length < 1 )
                return new Promise((resolve, reject) => {resolve();});

            
            return Plotly.deleteTraces(plotDiv, tracesToDelete);
            
            
        }

      function highlightInWellChartsSelectedWells(names, data, groupName){

            if( names == undefined ) return;
            let traceIndex = -1;
            let markersAdded = 0;
            let points = [];

            for(let trace of data){
                
                console.log('checking one trace named ', trace.name);
                traceIndex = traceIndex + 1;
                let text = trace.text;
                if(text == undefined) continue;

                for( let name of names ){
                    
                    let index = text.indexOf(name);
                    if( index !=-1 ) {
                        console.log('found well name', name, 'in trace', traceIndex, ' point index', index, 'axes',trace.xaxis,trace.yaxis  ); 
                        points.push( {x:trace.x[index], y:trace.y[index],text:trace.text[index],xaxis:trace.xaxis,yaxis:trace.yaxis} )
                        markersAdded+=1;
                    }
                }
            }

            /*now lets create a new trace*/
            let traceMap = {};
            let counter = 0;
            let showlegend = true;

            for (let pt of points) {
                let key = `${pt.xaxis}-${pt.yaxis}`;
                if (!traceMap[key]) {

                    showlegend =  counter == 0 ? true : false
                    counter+=1;

                    traceMap[key] = {
                        x: [],
                        y: [],
                        text: [],
                        marker:{
                            size: highlighted_marker_size,
                            color: highlighted_marker_color
                        },
                        xaxis: pt.xaxis,
                        yaxis: pt.yaxis,
                        mode: 'markers+text',
                        type: 'scatter',
                        name: groupName,
                        legendgroup: groupName,
                        showlegend: showlegend
                    };
                }
                traceMap[key].x.push(pt.x);
                traceMap[key].y.push(pt.y);
                traceMap[key].text.push(pt.text);
            }

            // Convert grouped traces into an array
            let traces = Object.values(traceMap);
            console.log( 'tracess to add')
            console.log( traces )

            return Plotly.addTraces(plot, traces );//, plot.layout, plot.config);
        }


        console.log('**MAIN app: wells-names-selected-in-locs-chart', evt.detail);
        
        //can i highlight the wells in the wells selected in the charts in the locs chart? 
        let plot = Id('sector-plot-wells');

        if(plot!=undefined){
        
            let data = plot.data;
            let names = evt.detail.names;
            deleteTracesInLegendGroup(plot, 'Selected loc.'). then( ()=>{
            if( (names!=undefined) && (names.length > 0) ){
                highlightInWellChartsSelectedWells(names, data, 'Selected loc.');
            }
        });
        }

    })

    /*single-well detail*/
    window.addEventListener('well-name-selected', (evt)=>{
        
  
        let read_data = get_project_data_selection();
        read_data['well_name'] = evt.detail.name;
   

           

        toggleLoading(true);
        get_server('tell_me_everything_about_this_well','POST',JSON.stringify(read_data))
        .then( (resp) =>{
            console.log('tell_me_everything_about_this_well returned', resp);
            let data = resp.data;
            console.log( resp )
            console.log( data )

            const dialog = document.getElementById("dell-detail-dialog");
            dialog.style.display = "flex";
            document.getElementById("dell-detail-dialog-header").textContent = data['well_name'];

            const tbody = document.getElementById("dell-detail-dialog-table-body");
            tbody.innerHTML = "";
            data['neighbours'].forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${row.name}</td><td>${row.distance}</td><td>${row.type}</td>`;
                tbody.appendChild(tr);
            });

            let rates =  data['rates'];
            let dates =  data['rates']['dates'];
            const traces = [];
            for (const rate in rates) {
                if(rate=='dates')
                continue;

                traces.push({
                    x: dates, y: rates[rate], mode: 'lines', name: rate,
                    type: 'scatter'
                });
            }


            Plotly.newPlot("dell-detail-dialog-chart", traces, 
            { autosize:true, 
              x: {automargin:true},y: {automargin:true},
              //title: {'text':'Well rates', font: {size:20}},
              responsive: true
            },
            {responsive: true});
        
            //let chartData = data['chart_data'];
            //let tableData = data['table_data'];
            //showSampleDialog(33);

            toggleLoading(false);
        })
        .catch ((error) =>{
            console.log(error);alert('Error getting data for field data');
            toggleLoading(false);
        });



        //l/et well_details = 1120.00; 
        ///showSampleDialog( well_details );

    });


</script>

</body>
</html>
