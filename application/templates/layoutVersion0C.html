<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Main Layout Component</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <!-- Add Plotly CDN -->
     <script src='https://cdn.plot.ly/plotly-3.0.0.min.js'></script>
     <!--script src = "components.js"></script-->
     <!--script src= "app_components.js"></script-->

     <script src="{{ url_for('static', filename='globals.js') }}"></script>
     <script src="{{ url_for('static', filename='components.js') }}"></script>
     <script src="{{ url_for('static', filename='app_components.js') }}"></script>
     <script src="{{ url_for('static', filename='support.js') }}"></script>
     <script src="{{ url_for('static', filename='locs_chart_support.js') }}"></script>
     
     <link href ="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">

     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

     <script src="{{ url_for('static', filename='crm_simulation_export.js') }}"></script>

 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

 <style>
 

    .qsthree-col-layout-navbar {
      position: sticky;
      top: 0;
      height: 56px;
      background-color: #333;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 16px;
      z-index: 10;
    }

    .qsthree-col-layout-main {
      display: flex;
      height: calc(100vh - 76px - 11px);
      margin-top: 1px;
      border: 2px solid black;
    }

    .qsthree-col-layout-column {
      height: 100%;
      overflow: auto;
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    .qsthree-col-layout-col1 {
      width: 20%;
    }

    .qsthree-col-layout-col2 {
      width: 40%;
    }

    .qsthree-col-layout-col3 {
      width: 40%;
    }

    #left-top,
    #left-bottom {
      aaflex: 1;
      overflow-y: auto;
    }

    .qsthree-col-layout-horizontal-resizer {
      flex: 0 0 5px;
      min-height: 15px;
      background: #ccc;
      cursor: row-resize;
      z-index: 2;
    }
    .qsthree-col-layout-horizontal-resizer:hover {
    background-color: #333;
    }

    .qsthree-col-layout-vertical-resizer:hover {

        background-color: #333;
    }

    .qsthree-col-layout-vertical-resizer {
      width: 15px;
      background: #ccc;
      cursor: col-resize;
      position: relative;
      z-index: 1;
    }

    .qsthree-col-layout-content {
      flex: 1;
      overflow: auto;
    }

    .qsthree-col-layout-resizing {
      user-select: none;
    }
  </style>
</head>

<script>

    class QuickJS_ThreeColLayout extends HTMLElement{
      _renderedTabs
      constructor(){
  
        super();
        this._renderedTabs = new Set();
      }
  
      getTemplate(){
  
      return `
        <div class="qsthree-col-layout-main">
          <!-- Column 1 -->
          <div style='overflow-y:hidden;'  class="qsthree-col-layout-column qsthree-col-layout-col1" id="left">
            <div style= 'max-height: 100%;flex-basis: 70%;' id="left-top">Left Top</div>
            <div class="qsthree-col-layout-horizontal-resizer" id="horizontalResizer"></div>
            <div style='max-height: 100%;flex-basis: 30%;'id="left-bottom">Left Bottom</div>
          </div>
          <div class="qsthree-col-layout-vertical-resizer" id="vResizer1"></div>
  
          <!-- Column 2 -->
          <div class="qsthree-col-layout-column qsthree-col-layout-col2" id="middle">
            <div class="qsthree-col-layout-content">Center</div>
          </div>
          <div class="qsthree-col-layout-vertical-resizer" id="vResizer2"></div>
  
          <!-- Column 3 -->
          <div class="qsthree-col-layout-column qsthree-col-layout-col3" id="right">
            <div class="qsthree-col-layout-content">Right</div>
          </div>
        </div>
        `;
      }
  
      connectedCallback(){
  
        this.render();
  
        this.setup();
      }
  
      render(){
  
        this.innerHTML = this.getTemplate();
  
      }
  
      setupVerticalResizer(resizer, leftEl, rightEl) {
        let isDragging = false;
  
        resizer.addEventListener('mousedown', (e) => {
          isDragging = true;
          document.body.classList.add('qsthree-col-layout-resizing');
  
          const container = resizer.parentElement;
          const startX = e.clientX;
          const startLeftWidth = leftEl.getBoundingClientRect().width;
          const startRightWidth = rightEl.getBoundingClientRect().width;
          const containerWidth = container.clientWidth;
  
          function onMouseMove(e) {
            if (!isDragging) return;
  
            const dx = e.clientX - startX;
            let newLeftWidth = startLeftWidth + dx;
            let newRightWidth = startRightWidth - dx;
  
            if (newLeftWidth < 50 || newRightWidth < 50) return;
  
            const newLeftPercent = (newLeftWidth / containerWidth) * 100;
            const newRightPercent = (newRightWidth / containerWidth) * 100;
  
            leftEl.style.width = `${newLeftPercent}%`;
            rightEl.style.width = `${newRightPercent}%`;
          }
  
          function onMouseUp() {
            isDragging = false;
            document.body.classList.remove('qsthree-col-layout-resizing');
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
  
            // Emit custom event
            const event = new CustomEvent('pane-resized', {
              detail: {
                id: leftEl.id,
                offsetWidth: leftEl.offsetWidth,
                offsetHeight: leftEl.offsetHeight
              },
              bubbles: true,
              composed: true
            });
            resizer.dispatchEvent(event);
  
  
  
            // Emit custom event
            const event2 = new CustomEvent('pane-resized', {
              detail: {
                id:  rightEl.id,
                offsetWidth: rightEl.offsetWidth,
                offsetHeight: rightEl.offsetHeight
  
              },
              bubbles: true,
              composed: true
            });
            resizer.dispatchEvent(event2);
  
  
  
          }
  
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
  
  
  
  
        });
      }
  
      setupHorizontalResizer(resizer, topEl, bottomEl) {
        let isDragging = false;
  
        resizer.addEventListener('mousedown', (e) => {
          isDragging = true;
          document.body.classList.add('qsthree-col-layout-resizing');
  
          const container = topEl.parentElement;
          const startY = e.clientY;
          const startTopHeight = topEl.getBoundingClientRect().height;
          const startBottomHeight = bottomEl.getBoundingClientRect().height;
          const containerHeight = container.clientHeight;
  
          function onMouseMove(e) {
            if (!isDragging) return;
  
            const dy = e.clientY - startY;
            let newTopHeight = startTopHeight + dy;
            let newBottomHeight = startBottomHeight - dy;
  
            if (newTopHeight < 50 || newBottomHeight < 50) return;
  
            const newTopPercent = (newTopHeight / containerHeight) * 100;
            const newBottomPercent = 100 - newTopPercent;
  
            topEl.style.flex = '0 0 ' + newTopPercent + '%';
            bottomEl.style.flex = '0 0 ' + newBottomPercent + '%';
          }
  
          function onMouseUp() {
            isDragging = false;
            document.body.classList.remove('qsthree-col-layout-resizing');
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
  
            // Emit custom event
            const event = new CustomEvent('pane-resized', {
              detail: {
                id: topEl.id,
                offsetWidth: topEl.offsetWidth,
                offsetHeight: topEl.offsetHeight
                
              },
              bubbles: true,
              composed: true
            });
            resizer.dispatchEvent(event);
  
  
            // Emit custom event
            const event2 = new CustomEvent('pane-resized', {
              detail: {
                id:   bottomEl.id,
                offsetWidth: bottomEl.offsetWidth,
                offsetHeight: bottomEl.offsetHeight
              },
              bubbles: true,
              composed: true
            });
            resizer.dispatchEvent(event2);
            
  
          }
  
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
      }
  
      setup(){
      // Init vertical resizers
      this.setupVerticalResizer(
        this.querySelector('#vResizer1'),
        this.querySelector('.qsthree-col-layout-col1'),
        this.querySelector('#middle')
      );
  
      this.setupVerticalResizer(
        this.querySelector('#vResizer2'),
        this.querySelector('#middle'),
        this.querySelector('#right')
      );
  
      // Init horizontal resizer
      this.setupHorizontalResizer(
        this.querySelector('#horizontalResizer'),
        this.querySelector('#left-top'),
        this.querySelector('#left-bottom')
      );
  
      }
    
    
      set(where, content) {


          
   
          const validPanes = ['left-top', 'left-bottom','middle', 'right', 'middle-top', 'middle-bottom', 'right-top', 'right-bottom']; 

  
          // Check if 'where' is valid
          if (validPanes.includes(where)) {
            if( where == 'middle-top') where = 'middle';
              if( where == 'right-top') where = 'right';
              

              const pane = this.querySelector(`#${where}`);
  
              if (typeof content === 'string') {
                  pane.innerHTML = content;  // Set content as innerHTML if it's a string
              } else if (content instanceof HTMLElement) {
                  pane.innerHTML = ''; // Clear existing content
                  pane.appendChild(content);  // Append the HTML element
              } else {
                  console.error('Content must be a string or an HTML element');
              }
          } else {
              console.error('Invalid pane ID');
          }
  
  
      }
      clear(where) {
        //const validPanes = ['left-top', 'left-bottom','middle', 'right'];
        const validPanes = ['left-top', 'left-bottom','middle', 'right', 'middle-top', 'middle-bottom', 'right-top', 'right-bottom']; 
    
          // Check if 'where' is valid
          if (validPanes.includes(where)) {
            if( where == 'middle-top') where = 'middle';
              if( where == 'right-top') where = 'right';
              


              const pane = this.querySelector(`#${where}`);
              pane.innerHTML = ''; // Clear existing content
          }
  
  
      }
      append(where, content) {
        //const validPanes = ['left-top', 'left-bottom','middle', 'right'];
        const validPanes = ['left-top', 'left-bottom','middle', 'right', 'middle-top', 'middle-bottom', 'right-top', 'right-bottom']; 
      
          // Check if 'where' is valid
          if (validPanes.includes(where)) {
            if( where == 'middle-top') where = 'middle';
              if( where == 'right-top') where = 'right';
              

              const pane = this.querySelector(`#${where}`);
  
              //if (typeof content === 'string') {
              //    pane.innerHTML = content;  // Set content as innerHTML if it's a string
  
              if (content instanceof HTMLElement) {
                  //pane.innerHTML = ''; // Clear existing content
                  pane.appendChild(content);  // Append the HTML element
              } else {
                  console.error('Content must be a an HTML element');
              }
          } else {
              console.error('Invalid pane ID');
          }
  
  
      }
      get_pane(id) {
         // const validPanes = ['left-top', 'left-bottom',
         //     'middle',  'right'
         // ];
          const validPanes = ['left-top', 'left-bottom','middle', 'right', 'middle-top', 'middle-bottom', 'right-top', 'right-bottom']; 
          let where = id; 
          // Check if 'where' is valid
          if (validPanes.includes(id)) {

              if( where == 'middle-top') where = 'middle';
              if( where == 'right-top') where = 'right';
              

              const pane = this.querySelector(`#${where}`);
              return pane;
          }else {
          console.error(`Invalid pane ID "${id}". Valid IDs are: ${validPanes.join(', ')}`);
          return null;
              }
  
      }
  
  
    }
    customElements.define("new-three-column-main-layout", QuickJS_ThreeColLayout);
  
  
  
    </script>

<body>
    <script>function Id(id){return document.getElementById(id)}</script>

    <!-- floating well-detail-dialog -->
    <div id="dell-detail-dialog" class="hidden dell-detail-dialog-panel">
        <div class="dell-detail-dialog-close" onclick="closeWellDetailDialog()">âœ–</div>
        <div id="dell-detail-dialog-header" class="dell-detail-dialog-header">WELL NAME</div>
    
      
        <div style='min-height:400px; height:400px' id="dell-detail-dialog-chart" class="dell-detail-dialog-chart"></div>
        <span class="subtitle">Closest neighbours</span>
        <table class="dell-detail-dialog-table">
          <thead>
            <tr>
              <th>Well</th>
              <th>Distance</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="dell-detail-dialog-table-body"></tbody>
        </table>
        <!-- Sector: 3<br>
        Reservoir: Wara<br>
        RMU: LW<br> -->
        <hr>
        <button class="well-detail-dialog-close-button btn btn-danger" onclick="closeWellDetailDialog()">Close</button>
        
    </div>
  


    <!-- spinning indicator of a long operation -->
    <div id="loading" class="loader hidden"><div class="spinner"></div>Loading...</div>
    <script>function toggleLoading(show) {
        let message = document.getElementById("loading");//.style.display = show ? "block" : "none";

        if (show) {
            message.classList.remove('hidden');// .style.display = "block"; // Show message
        } else {
            message.classList.add('hidden');// .style.display = "none"; // Hide message
        }
      

    }</script>
  

    <div id='projects-component-container' class="hidden pane projects-component-container">

   
        <div class="projects-component-left">
            <h1 style="font-size: 46px;">Waterflood Insights</h1>
            <h2>Open project</h2>
        </div>
    
        <div class="projects-component-divider"></div>
    
        <div class="projects-component-right">
            <project-list-component id="project-list-component"></project-list-component> <!-- Custom Component -->
        </div>
    </div>


    <div id="top-right-pagination" style="display:flex;flex-direction: column;height: 100%;">

        <!-- top menu -->
        <div style='display: flex; height: 50px; flex-wrap: wrap; gap: 8px; padding: 8px;'>
            <ul class="pagination">
            <li class="page-item">
                <a onclick="showCharts([0, 1, 2],this)" id='field-tab-button' class="field-tab btn-sm page-link">Field</a>
            </li>

            <li class="page-item">
                <a onclick="showCharts([3],this)"  id='sector-tab-button' class="field-tab btn-sm  page-link">Sector </a>
            </li>
            <li class="page-item">
                <a onclick="showCharts([4],this)"  id='wells-tab-button'class="field-tab btn-sm page-link">Wells</a>
            </li>
            <li class="page-item">
                <a onclick="showCharts([5],this)"  id='workflows-tab-button'class="field-tab btn-sm page-link">Workflows</a>
            </li>
            <li class="page-item">
                <a onclick="showCharts([6],this)"  id='results-tab-button'class="field-tab btn-sm page-link">Simulation</a>
            </li>

            </ul>
        </div>

        <!-- charts menu -->
        <div id="chart-container" style="background-color: blueviolet; display: flex; flex-direction: column; gap: 5px; height: 100%; width: 100%;">
            <div id="chart-1" class="chart-box" style="flex: 1; width: 100%;"></div>
            <div id="chart-2" class="chart-box" style="flex: 1; width: 100%;"></div>
            <div id="chart-3" class="chart-box" style="flex: 1; width: 100%;"></div>
            <div id="chart-4" class="chart-box" style="flex: 1; width: 100%;"></div>
            <div id="chart-5" class="chart-box" style="flex: 1; width: 100%;"></div>

            <div id="chart-6" class="chart-box" style="flex: 1;">Workflows</div>
            <div id="chart-7" class="chart-box" style="flex: 1;">Simulations</div>
        </div>

        <script>
              function showCharts(indexes, ele) {
                const chartDivs = [
                document.getElementById('chart-1'),
                document.getElementById('chart-2'),
                document.getElementById('chart-3'),
                document.getElementById('chart-4'),
                document.getElementById('chart-5'),

                document.getElementById('chart-6'),
                document.getElementById('chart-7')
                ];
            
                document.querySelectorAll('.field-tab').forEach((tab) => {
                    tab.classList.remove('selected');
                });
                ele.classList.add('selected');

                chartDivs.forEach((div, i) => {
                div.style.display = indexes.includes(i) ? 'block' : 'none';if (indexes.includes(i)) Plotly.Plots.resize(div);});
            }



        </script>
    </div>

     

            <!--script>

                Id('field-tab-button').addEventListener( 'click',()=>{
              
                    document.querySelectorAll('.plots-tab-1').forEach(container => {
                        container.style.display = 'flex';
                    });
                    document.querySelectorAll('.plots-tab-2').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.plots-tab-3').forEach(container => {
                        container.style.display = 'none';
                    });
                });

                Id('wells-tab-button').addEventListener( 'click',()=>{
                    document.querySelectorAll('.plots-tab-1').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.plots-tab-2').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.plots-tab-3').forEach(container => {
                        container.style.display = 'flex';
                    });

                });
                Id('sector-tab-button').addEventListener( 'click',()=>{
                    document.querySelectorAll('.plots-tab-1').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.plots-tab-2').forEach(container => {
                        container.style.display = 'flex';
                    });
                    document.querySelectorAll('.plots-tab-3').forEach(container => {
                        container.style.display = 'none';
                    });

                });


                /*let tabs = document.querySelectorAll('.field-tab');

                

                tabs.forEach((tab) => {
                    tab.addEventListener('click', function(){
                        alert('clicled', )
                        /*tabs.forEach((t) => {
                            t.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        */
                   // });
                //});*/
            </script -->
        
     

        <!-- div style="gap:8px; display:flex;flex-direction: column;height: 100%;background-color: aqua;" 
        id="field-charts-container" 
        class="aafield-chart-container">
        </div -->

        <!-- wrapper for all charts -->
        <!-- div style="aflex: 1 1 100%; overflow: auto; adisplay: flex; aflex-direction: acolumn; heigh:100%; min-height: 100%; background-color: indianred;">
    -->
            <!-- just for margins...etc-->
            <!--div style="display: block; flex: 1 1 0%; padding: 8px; background-color: orange;">

                <div id="field-charts-container" class="field-chart-container" style="width:100%;height:100%;display:flex;flex-direction:column;gap:16px;">
                    <p>Field charts go here...</p></div>
            </div>

            <div style="display: none; flex: 1 1 0%; padding: 8px; background-color: orange;">

                <div id="sector-charts-container" class="field-chart-container" style="width:100%;height:100%;display:flex;flex-direction:column;gap:16px;">
                <p>Sector charts go here...</p></div>

            </div>

           
            <div style="display: block; flex: 1 1 0%; padding: 8px; background-color: orange;">
                <div id="wells-charts-container" class="field-chart-container" style="width:100%;height:100%;display:flex;flex-direction:column;gap:16px;">
                    <p>Wells charts go here...</p></div>   
            </div>

            <div style="display: block; flex: 1 1 0%; padding: 8px; background-color: orange;">
                <div id="workflows-charts-container" class="field-chart-container" style="width:100%;height:100%;display:flex;flex-direction:column;gap:16px;">
                    <p>workflows go here...</p></div>   
            </div>

            <div style="display: block; flex: 1 1 0%; padding: 8px; background-color: orange;" style="width:100%;height:100%;display:flex;flex-direction:column;gap:16px;">
                <div id="results-charts-container" class="field-chart-container">
                    <p>workflows results go here...</p></div> 
            </div-->

        <!--/div -->



 
    <!--script>
        document.querySelector('.field-tab').addEventListener('click', (e) => {
        alert('clicked', e.target.id);
        document.querySelectorAll('.js-plotly-plot').forEach(plot => {
            Plotly.Plots.resize(plot);
        });
        });
    </script-->

        <!--    
        <div id="field-charts-container" class="field-chart-container" xstyle="background-color: grey; min-height:99vh; max-height:99vh; height: 99vh">
        <p>Field charts go here...</p></div>
        <div id="sector-charts-container" class="field-chart-container" xstyle="background-color: grey; min-height:99vh; max-height:99vh; height: 99vh">
        <p>Sector charts go here...</p></div>
        <div id="wells-charts-container" class="field-chart-container" xstyle="background-color: grey; min-height:99vh; max-height:99vh; height: 99vh">
        <p>Wells charts go here...</p></div>        
        <div id="workflows-charts-container" class="field-chart-container">
            <p>workflows go here...</p></div>        
    
            <div id="results-charts-container" class="field-chart-container">
                <p>workflows results go here...</p>
            </div>   
        -->    
            

        <!-- script>
            let items = document.querySelectorAll('.field-tab');     
            items.forEach((item) => {
                item.addEventListener('click', function(){                  
                    console.log()
                    let atabs = document.querySelectorAll('.field-chart-container'); 
                    let tab_id = this.id.split('-')[0]+'-charts-container';
                    atabs.forEach((aatab) => {
                        console.log('aatab id', aatab.parentElement.id)
                        if( aatab.id!=tab_id)
                            {aatab.parentElement.style.display = 'none';
                            
                            }
                        else {aatab.parentElement.style.display = 'block'; console.log('showing ', aatab)} 
                    });
                });
            }); 
        </script -->


    <div id='side-bar-top' class="h50  p-3">
          
        <button id='data-tab1' class="btn btn-sm" onclick="showCard('data-selection-card',this)">Data</button>
        <button class="btn btn-sm" onclick="showCard('studies-selector-card',this)">Studies</button>
        <button class="btn btn-sm" onclick="showCard('views-selector-card',this)">Views</button>
        <!--button class="btn btn-sm" onclick="showCard('workflows-selector-card',this)">Workflows</button-->


        <div class="card" id="data-selection-card">
            <div>
                <label id='project_name' class="subtitle">Project name</label>
                <hr>

                <p class="subtitle">Reservoir management unit</p>
                <combobox-component id="reservoir-unit-selector"></combobox-component>
            </div>
            <div>
   
                <details><summary style="margin-top:5px; font-weight: bold;font-size: 1.1em;">Sectors</summary>
                <two-column-checkbox-list id="sector-selector"></two-column-checkbox-list>
               </details>
            </div>
            <div>
                <p class="subtitle">Time frame</p>
                <label for="start-date" class="form-label">Start:</label>
                <input type="date" id="start-date" name="start-date" class="form-control mb-2">
                <label for="end-date" class="form-label">End:</label>
                <input type="date" id="end-date" name="end-date" class="form-control">
        
                <double-range-component></double-range-component>
                <p></p>
                Displace time frame and load data 
                <div class="d-flex align-items-center gap-2">
                    
                    <button class="btn btn-primary" id="time-frame-player-left-button">
                        <i class="fas fa-caret-left"></i>
                    </button>
                    <input type="number" id="range-value" name="range-value" class="form-control text-center" min="1" max="180" value="1" style="width: 80px;">
                    <button class="btn btn-primary" id="time-frame-player-right-button">
                        <i class="fas fa-caret-right"></i>
                    </button>
                </div>
        
            </div>
            <hr>
            <button id='apply-data-selection-button' class="btn btn-primary">Apply</button>        
        </div>

        <div class="card" id="studies-selector-card">
            <stringlist-component  
            checkboxes=true 
            selection_mode='single' 
            id='study-selector'>
        </stringlist-component>
            <button id='study-selector-button' class="btn btn-primary">Load</button>
        </div> 
     
        <div class="card" id="views-selector-card">
            <span>Text on charts <input type="checkbox" id="display-text-on-chart-button" name="display-option" value="text"></span>
            <script>Id('display-text-on-chart-button').addEventListener('click',(evt)=>{

                //let text_on_charts = evt.target.checked;
                //alert('changed',  text_on_charts);
            });</script>
        </div>
          

    </div>

    <div id='side-bar-bottom'  class="h50 p-3" astyle="top: 50%;">
        
        <p class="subtitle">Workflows</p>
        <div class="card" id="workflows-selector-card">
            <stringlist-component id='workflow-selector' checkboxes=true 
            notitle='Workflows' selection_mode='single'> 
            </stringlist-component>
        </div>
    </div>

    <!-- Sticky Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">

            <button id="debug-stuff1">Debug stuffg</button>

            <div class="container-fluid">
                <a class="navbar-brand" href="#">Waterflood insights</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
    
          
         
    
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a id='initialize-app-button'class="nav-link active" aria-current="page">Initialize</a>
                        </li>

                      
                    </ul>
 
                    <button style='float:right' id="projects-list-button">Projects</button>
             
                    <button style='float:right' id="check">Debug</button>
                    <script>
                        Id('check').addEventListener('click', function(){
            
              
            
                            alert('clicked');
                            let extra_stuff = Id('extra-stuff');
                            let field_stuff = Id('field-stuff');
                            
                            if(extra_stuff.classList.contains('hidden')){
                                extra_stuff.classList.remove('hidden');
                                //field_stuff.classList.add('hidden');
                            }else{  
                                extra_stuff.classList.add('hidden');
                                //field_stuff.classList.remove('hidden');
                            }
                                
                        });
                    </script>
    
                    <button style='aamargin-left:20%'class="warning-button" 
                    id="well-selection-indicator">
                        <span class="warning-icon">&#9888;
                          Well selection active
                        </span>
                      </button>
                </div>
    
      
    
          
    
            </div>
    
    
    
          
    
    </nav>


    <div id='all-app-wrapper' class="container-fluid no-hidden">


    <div style="position: relative;top: 75px;" >
        <div class="row">
                <!--div class="col-2" style="background-color: black; 4height: 100vh;">
                    Left menu
                </div-->

            <div id='field-stuff' class="col-12">
            <!--three-column-main-layout id = "main-layout"></three-column-main-layout-->
            <new-three-column-main-layout id = "main-layout"></three-column-main-layout>

            </div>

            <div id='extaara-stuff' class="col-12 hidden" style="height: 100vh;">
                <div id = "extra-layout">  I am hidden </div>
            </div>
    

            <div id='extra-stuff'  class="col-12 hidden row bg-primary" style="height:calc(100vh - 57px);">
                <tabs-component id="bottom-tabs"></tabs-component>
                <script>
                    Id('bottom-tabs').addNewTab('tab1', 'sdfgsdgdfg');
                    Id('bottom-tabs').addNewTab('tab2', 'sdfgsdgdfg');
                    Id('bottom-tabs').addNewTab('tab3', 'sdfgsdgdfg');
                    
                </script>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p>
                <p>sdfdsfdf</p> 
            </div>
            
        </div>
    </div>

    </div>


<script id="initialize-app">

    let layout = Id('main-layout');
    let project_description; 

    function Id( id ) { return document.getElementById(id); }    
  
    function load_empty_app(){

 
        
        layout.set('left-top',Id('side-bar-top'));
        layout.set('left-bottom',Id('side-bar-bottom'));
        layout.set('right-top',Id('top-right-pagination'));
     
        Id('data-tab1').click()
        Id('field-tab-button').click()
        
        iurl = 'get_list_of_projects';
        get_server(iurl, 'GET' )
            .then( (resp) =>{
                console.log('get_list_of_projects returned', resp);
                let projects = resp.data['projects'];
                let project_list = Id('project-list-component');
                project_list.projects = projects;
            })
            .then( ()=>{
                display_projects_page(true);
            } )
            .then (()=>{

              
                //d//ocument.querySelector('.projects-component-button').click();
                //Id('projects-component-container').classList.add('hidden');
                //Id('all-app-wrapper').classList.remove('hidden');
                //Id('project-list-component').click();
                //load_project( 'project_name');

                //let box = document.querySelector('#reservoir-unit-selector');//.click();
                //let options = box.getOptions();
                //console.log('options', options)
                //box.setValue( 'LW' );
                //Id('apply-data-selection-button').click();*/



            })

            .catch ((error) =>{
                console.log(error);
            });
    
    
    //document.querySelector('.projects-component-button btn btn-primary').click();

    }



    
    function load_project( project_name){
    
        console.log('load_project', project_name);

        return new Promise((resolve, reject) => {
            let iurl = 'get_project_description'
            let message = JSON.stringify( {project_name:project_name} )

            get_server(iurl, 'POST', message )
            .then( (resp) =>{
            console.log('get_project_description returned', resp);
            project_description = resp.data;
            resolve(resp.data);
            })
        .catch ((error) =>{
            console.log(error);
            });
        });
    }
 

    let resizePending = false;
    window.addEventListener('resize', () => {resizePending = true;});
    layout.addEventListener('pane-resized', () => {resizePending = true;});
    window.addEventListener('mouseup', () => { 
        
        return;
        //console.log('mouseup...', resizePending);
        if(resizePending == true){
        
            let containers = document.querySelectorAll('.field-chart-container');
            containers.forEach((container) => {

                console.log('container:', container.offsetWidth, container.offsetHeight);
                let parent = container.parentElement;
                console.log('parent container:', parent.id,parent.offsetWidth, parent.offsetHeight);
                

                let plots = container.querySelectorAll('.js-plotly-plot');
                if(plots != null){
                    
                    for(let plt of plots){
                    try{
                    const layout = plt.layout;
                    console.log('layout', layout);
                    layout['width'] = parent.offsetWidth;
                    layout['autosize'] = true;
                    Plotly.Plots.resize(plt);
                    }catch(e){
                        console.log('Error resizing plot:', e);
                    }}

                }
            }); 

            resizePending = false;
        }
    });
  

</script>
   
<script id='ui_events'>

    function display_projects_page( value ){

        if(value == true){
            Id('projects-component-container').classList.remove('hidden');
            Id('all-app-wrapper').classList.add('hidden');
        }
        else{
            Id('projects-component-container').classList.add('hidden');
            Id('all-app-wrapper').classList.remove('hidden');
        }
    }

    function load_and_display_study(study_name){

        console.log('loading and displaying a study named ', study_name);
        toggleLoading(true);
        setTimeout(()=>{
            toggleLoading(false);
        }, 2000);
        

    }

    async function get_charts_data(read_data){
    /*
    Get the hard-coded charts to show by default
    */


        try{
            toggleLoading(true);

            resp = await get_server('get_default_charts','POST', JSON.stringify(read_data));

            let data = resp.data;
            console.log('get_default_charts returned',data);

            //let locs_figure = data['locations'];
            populate_locations_plot( data );
            all_well_names_visible = data['all_names'];

            const chartDivs = [
                document.getElementById('chart-1'),
                document.getElementById('chart-2'),
                document.getElementById('chart-3'),
                document.getElementById('chart-4'),
                document.getElementById('chart-5'),

                document.getElementById('chart-6'),
                document.getElementById('chart-7')
                ];

            
            //#first tab of charts 
            let chart_keys = ['fractions','historical_production', 'activity'];
            Plotly.newPlot(chartDivs[0], data['fractions']['data'], data['fractions']['layout'], {responsive: true}).then ((p)=>{});  
            Plotly.newPlot(chartDivs[1], data['historical_production']['data'], data['historical_production']['layout'], {responsive: true}).then ((p)=>{});  
            Plotly.newPlot(chartDivs[2], data['activity']['data'], data['activity']['layout'], {responsive: true}).then ((p)=>{});  

            Plotly.newPlot(chartDivs[3], data['sector_volumes']['data'], data['sector_volumes']['layout'], {responsive: true}).then ((p)=>{});
            
            const layout = {
                grid: {rows: 3, columns: 1, pattern: 'independent'},
                title: { text:' Cummulated volumes vs water produced'},
                autosize: true,
                automargin: true,
                //margin: {l: 70, r: 40, t: 40, b: 30},
                xaxis1:  {matches: 'x'},
                xaxis2: {matches: 'x'},
                xaxis3: {matches: 'x'},
                xaxis4: {matches: 'x'},
                yaxis1: { title:{text: 'Gas production'}},
                yaxis2: { title:{text: 'Oil production'}},
                yaxis3: { title:{text: 'Liquid production'}},
            };
            Plotly.newPlot(chartDivs[4], data['wells']['data'], layout, {responsive: true}).then ((p)=>{});  

            let component = new CRMSetupElement();//crm-setup-element
            chartDivs[5].innerHTML = '';
            chartDivs[5].appendChild(component);

            console.log('here');
            /*
                   fractions = fractions_fig, 
                   historical_production = producers_fig, 
                   activity = active_fig,

                   #second tab
                   sector_volumes = sector_volumes_fig, 
                   
                   #third tab
                   wells = wells_chart,
                     
                   #locations 
                   locations = locs_fig,
                   all_names = all_names)
                   */


            /*
            const resp1 = await get_server('get_locations_chart','POST', JSON.stringify(read_data))
            populate_locations_plot(resp1.data);
            all_well_names_visible = resp1.data['all_names'];
            
            const resp2 = await get_server('get_field_charts','POST', JSON.stringify(read_data))
            populate_field_plots(resp2.data);
                
            const resp3 = await get_server('get_field_wells','POST', JSON.stringify(read_data))
            populate_field_wells_snapshot(resp3.data);
            
            const resp4 = await get_server('get_field_wells','POST', JSON.stringify(read_data))
            */

            toggleLoading(false);
            

            //const resp5= await  get_server('get_wells_data','POST', JSON.stringify(read_data))
            //all_well_distances = resp5.all_well_distances;

            
            
        }


        catch (error){
                console.log(error);
                toggleLoading(false);
                alert('Error getting data for basic plots');
            }; 

    }
    
    
    /*when the user double-clicks in one workflow item*/
    Id('workflow-selector').addEventListener('dclicked',(evt)=>{
        //console.log('Workflow double-clicked:', evt.detail);
        console.log('workflow name double-clicked:', evt.detail.cell_text);
        if( evt.detail.cell_text.toLowerCase() != 'liquid history match')
        {
            Swal.fire({
            title: "Sorry...not implemented yet",
            html: "Only a few (maybe just one) workflow can be trigerred at the moment", 
            icon: "info"
            });

        }
        else{

            let read_data = get_project_data_selection();
            let result  = validateProjectDataSelection( read_data );
            if( isEmptyOrWhitespace(result) == false){
                Swal.fire({title: "Error data selection",html: result.replaceAll("\n", "<br>"),icon: "error"});
                return
            }

           
            toggleLoading(true);
            get_server('get_crm_input_data','POST',JSON.stringify(read_data))
                .then( (resp) =>{

                console.log('data received from server', resp );//distances_data);
                /*Example of data received from the server
                {
                    "dates": [
                        "2023-01-01",
                        "2023-02-01",
                        "2023-03-01",
                        "2023-04-01",
                        "2023-05-01",

                    ],
                    "distances": [
                        {
                            "distance": 26724.086917357108,
                            "injector": "BG-0604-1_I",
                            "producer": "AH-0191-2_P"
                        },
                            "distance": 3278.951071158391,
                            "injector": "BG-0757-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 4096.706186426527,
                            "injector": "BG-0758-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 6207.797163274271,
                            "injector": "BG-0759-1_I",
                            "producer": "BG-1766-2_P"
                        },

                            "distance": 3497.938905346225,
                            "injector": "BG-0604-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 5340.539927885718,
                            "injector": "BG-0721-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 4398.491484930774,
                            "injector": "BG-0722-1_I",
                            "producer": "BG-2203-1_P"
                        },
                    ],
                    "liquid_production": {
                        "data": {
                            "AH-0191-2_P": [
                                407.61655,
                                450.985,
                                451.67915,
                                456.0019
                
                            ],
                            "BG-0052-6_P": [
                                0,
                                1431.2434999999996,
                                2778.53845,
                                2907.1412
                            ],
                            "BG-0234-1_P": [
                                289.47475,
                                310.58589999999987,
                                306.7277,
                                300.5669000000001,
                                326.1468,
                                341.34515
                            ]  
                        },
                        "dates": [
                            "2023-01-01",
                            "2023-02-01"
                        ]
                    },

                    "water_injection": .... ther same 
                }
                */

                let rates = {
                    liquid_production: resp['liquid_production'],
                    water_injection: resp['water_injection'],
                    dates :resp['dates']
                }

                let component = new CRMSetupElement();//crm-setup-element
                Id('workflows-charts-container').innerHTML = '';
                Id('workflows-charts-container').classList.remove('hidden');
                Id('workflows-charts-container').appendChild(component);
                Id('workflows-tab-button').click();

                component.setData( resp['distances'], rates )

                component.addEventListener('close-clicked', ()=>{
                    Id('workflows-charts-container').innerHTML = '';
                    Id('workflows-charts-container').classList.add('hidden');
                    
                    Id('field-tab-button').click();
                });

                /*run clicked*/
                component.addEventListener('clicked', (evt)=>{

                    console.log('Debugging setting a crm simulation parameters launch');

                    //crm setup
                    let crm_control_setup = evt.detail['crm_setup'];

                    //project name, sectors, subzone, etc.... 
                    let project_setup_details = get_project_data_selection();

  
                    let sim_params  = prepare_crm_simulation_export( crm_control_setup, project_setup_details);


                    console.log('Simulation parameters:', sim_params);



                    //send the entire thing to the backend
                    toggleLoading(true);
                    get_server('start_liquid_history_match_simulation','POST', JSON.stringify(sim_params))
                    .then( (resp) =>{
  
                        console.log('start_liquid_history_match_simulation returned', resp);
                      
                            let message = 'Simulation exported/launched successfully<br>'; 

                            Swal.fire({
                                title: "Simulation started",
                                html: message, 
                                icon: "success"
                            });
                
                        toggleLoading(false);

                    })  
                    .catch ((error) =>{
                        console.log(error);
                        alert('Error getting data for locations');
                        toggleLoading(false);
                    }); 

                     

                });



                toggleLoading(false);
                })
                .catch( (error) =>{

                    console.log(error)
                    toggleLoading(false);
                });


        }

        /*let w = new CRMSetupElement();//crm-setup-element
        Id('workflows-charts-container').innerHTML = '';
        Id('workflows-charts-container').appendChild(w);
        Id('workflows-tab-button').click();



        */
    });

    /* Trigerred when the user clicks on a study in the list.*/
    Id('study-selector-button').addEventListener('click',(evt)=>{

        //the study name is fetched from the list 
        let study_name = Id('study-selector').selected()[0]['cell_text'];
        console.log('**Study name clicked:', study_name);

        load_and_display_study(study_name);
    });

    /*When the user selects a project in the projects list page*/
    Id('project-list-component').addEventListener('clicked', event => {
        console.log("Project clicked:", event.detail.projectName);
        //alert(`Opening project: ${event.detail.projectName}`);


        toggleLoading(true);
        load_project(event.detail.projectName).then( (data)=>{

            data['project_name'] = event.detail.projectName;
            populate_project_description(data);
            display_projects_page(false);
            Id('field-tab-button').click()
            Id('data-tab1').click();
            toggleLoading(false);
        })
        .catch ((error) =>{
            console.log(error);
            toggleLoading(false);
        });
        ;
    });

    //navbar debug button
    Id('projects-list-button').addEventListener('click', function(){
        display_projects_page(true);
    });
    
    /* Trigerred when the user clicks "Apply" data selection in the left-top sidebar */
    Id('apply-data-selection-button').addEventListener('click', function(){
        
        let read_data = get_project_data_selection();
        let result  = validateProjectDataSelection( read_data );
        if( isEmptyOrWhitespace(result) == false){
            
            Swal.fire({
            title: "Error in selection",
            html: result.replaceAll("\n", "<br>"), 
            icon: "error"
             });
            return
        }
        if(read_data!=undefined){

            get_charts_data( read_data );
        }



        /* old version working smoothly 
        if(read_data!=undefined){

            toggleLoading(true);
            get_server('get_locations_chart','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                populate_locations_plot(resp.data);
                toggleLoading(false);
                all_well_names_visible = resp.data['all_names'];

            })  
            .catch ((error) =>{
                console.log(error);alert('Error getting data for locations');
                toggleLoading(false);
            }); 
            
            get_server('get_field_charts','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                console.log('get_field_charts returned', resp);
                populate_field_plots(resp.data);
            })
            .catch ((error) =>{
                console.log(error);alert('Error getting data for field data');
            }); 

            
            ////////////////
            get_server('get_field_wells','POST', JSON.stringify(read_data))
            .then( (resp) =>{
                console.log('get_field_wells_snapshot returned', resp);
                populate_field_wells_snapshot(resp.data);

                //dummy();
            })
            .catch ((error) =>{
                console.log(error);alert('Error getting data for field data');
            }); 
        }*/
    }); 

    Id('debug-stuff1').addEventListener('click', (evt)=>{
        console.log('debug-stuff1 clicked');














        return 
        let connectivities = [
            { 'producer':'BG-0724-3_P', 'injector': 'BG-0756-1_I', 'ALLOCATION': 0.96},
            { 'producer':'BG-0724-3_P', 'injector': 'BG-1723-1_I', 'ALLOCATION': 0.3},
        ]
        let r2 = [
            { 'producer':'BG-0724-3_P',  'r2': 0.96},
            { 'producer':'BG-0724-3_P',  'r2': 0.23}
        ]

        key = 'case_name_connect'

        
        let app_layout = Id('main-layout');
        let where = locations_chart_pane;
        let locs_container = app_layout.get_pane(where);// Id('locs-chart');
        highlightWellsInLocationsChart( locs_container, undefined , key )

        let lats  = [];
        let longs = []; 
        let text  = [];
        let lambdas   = []  
        const minWidth = 1;
        const maxWidth = 8;

        let traces = [ ]

        let last_trace = undefined;
        let counter = -1;


        for( let c of connectivities){
                    const [index1,series1] = findWellInLocationsChart( locs_container, c['injector'] );
                    const [index2,series2] = findWellInLocationsChart( locs_container, c['producer'] );


                    if ((index1!=-1) && (index2!=-1)){
                        counter += 1;
                        const [lat1,long1] = [series1['lat'][index1], series1['lon'][index1]];
                        const [lat2,long2] = [series2['lat'][index2], series2['lon'][index2]];

                        //console.log( 'lat1', lat1, 'long1', long1, 'lat2', lat2, 'long2', long2 );

                        //lats.push(lat1, lat2,undefined );
                        //longs.push(long1,long2,undefined );
                        //text.push( lambda['ALLOCATION'], lambda['ALLOCATION'],undefined );
                        
                        const width = 1 + (8 - 1) * c['ALLOCATION']; // scale 0â€“1 â†’ 1â€“8

                        let newTrace = {
                            legendgroup: key, 
                            showlegend: counter == 0, 
                        name : key,
                        type:"scattermap",
                        mode: "lines",
                        lat: [lat1,lat2],
                        lon: [long1,long2],
                        line: {
                        width: width,
                        color: valueToColor(c['ALLOCATION']),
                        },
                        text: [ c['ALLOCATION'].toString(), c['ALLOCATION'].toString() ], 
                        hovertemplate:'%{text}<br>',
             
                        //marker: { size: highlighted_marker_size, color:highlighted_marker_color }
                        //text: text,
                        //marker: { size: highlighted_marker_size, color:highlighted_marker_color, opacity: highlighted_marker_opacity  },
                }

                //Plotly.addTraces(locs_container, newTrace)

                        traces.push(newTrace);
                        last_trace = newTrace;
                    }
                }

                if(traces.length < 1 )
                return 

                    //last_trace['showlegend'] = true;
                    Plotly.addTraces(locs_container, traces).then ((p)=>{

                        console.log('traces added');

                    });

            







        return; 
        /*marking stuff in the locations chart*/
        let names = ['BG-1114-1_I','BG-1096-2_P'];
        //let app_layout = Id('main-layout');
        //let where = locations_chart_pane;
        //let locs_container = app_layout.get_pane(where);// Id('locs-chart');
       

        highlightWellsInLocationsChart( locs_container, names, 'Highlighted' );
  
        return 


















        function formatString(str) {
            if (!str) return '';
            const noUnderscores = str.replace(/_/g, ' ');
            return noUnderscores.charAt(0).toUpperCase() + noUnderscores.slice(1);
            }

        console.log('debug-stuff1 clicked');
        toggleLoading(true);

        //get the filters. Zone, subzone, wells_selected if any.
        //time slice. 
        let read_data = get_project_data_selection();
            
        //if we dont have a precise selection, then send all that are visuble 
        if( (read_data['name'].length == 0 ) || (read_data['name'] == undefined)) {
            read_data['name'] = all_well_names_visible;
        }


            

            
            get_server('get_crm_input_data','POST',JSON.stringify(read_data))
            .then( (resp) =>{
                
                console.log('get_crm_input_data returned');
                let crm_component = document.querySelector('crm-setup-element');
                let distances_data = resp['distances'];
                console.log('data received from server', resp );//distances_data);
                /*Example of data received from the server
                {
                    "dates": [
                        "2023-01-01",
                        "2023-02-01",
                        "2023-03-01",
                        "2023-04-01",
                        "2023-05-01",

                    ],
                    "distances": [
                        {
                            "distance": 26724.086917357108,
                            "injector": "BG-0604-1_I",
                            "producer": "AH-0191-2_P"
                        },
                            "distance": 3278.951071158391,
                            "injector": "BG-0757-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 4096.706186426527,
                            "injector": "BG-0758-1_I",
                            "producer": "BG-1766-2_P"
                        },
                        {
                            "distance": 6207.797163274271,
                            "injector": "BG-0759-1_I",
                            "producer": "BG-1766-2_P"
                        },

                            "distance": 3497.938905346225,
                            "injector": "BG-0604-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 5340.539927885718,
                            "injector": "BG-0721-1_I",
                            "producer": "BG-2203-1_P"
                        },
                        {
                            "distance": 4398.491484930774,
                            "injector": "BG-0722-1_I",
                            "producer": "BG-2203-1_P"
                        },
                    ],
                    "liquid_production": {
                        "data": {
                            "AH-0191-2_P": [
                                407.61655,
                                450.985,
                                451.67915,
                                456.0019
                
                            ],
                            "BG-0052-6_P": [
                                0,
                                1431.2434999999996,
                                2778.53845,
                                2907.1412
                            ],
                            "BG-0234-1_P": [
                                289.47475,
                                310.58589999999987,
                                306.7277,
                                300.5669000000001,
                                326.1468,
                                341.34515
                            ]  
                        },
                        "dates": [
                            "2023-01-01",
                            "2023-02-01"
                        ]
                    },

                    "water_injection": .... ther same 
                }
                */

                let n = -1
                let keys = ['liquid_production','water_injection']
                let containers = [ Id('liquid-production-rates-container'), Id('water-injection-rates-container')]
                for(let key of keys){
                    n = n + 1 
                    
                    let rates = resp[key]['data']
                    let dates =  resp[key]['dates']
                    const traces = [];
                    for (const well in rates) {
                    traces.push({
                        //works extra_stuff: dates, 
                        x: dates, y: rates[well], mode: 'lines', name: well,
                        type: 'scatter'
                    });
                    }

                    series_name = formatString( key )
                    let chart = containers[n];
                    chart.innerHTML = "";
                    Plotly.newPlot( chart, traces, {
                    title: {'text':series_name, font: {size:20}},
                    xaxis: { text: 'Date' },yaxis: { text: 'Value' }}, {'responsive': true});
                }

                


                //crm_component.setData( distances_data, resp['rates']);
                //let pairs = crm_component.extractPairs( 750 );
                //crm_component.setData( data['distances'], data['rates'] );
                //crm_component.extractPairs( 1750 );

                toggleLoading(false);
            })  
            .catch( (err) => {

                console.log('error', err);
                toggleLoading(false);
            });
         

    });

    Id('time-frame-player-left-button').addEventListener('click', (evt)=>{
    
        moveDates(-1);
        Id('apply-data-selection-button').click();
    });

    Id('time-frame-player-right-button').addEventListener('click', (evt)=>{
        moveDates(1);
        Id('apply-data-selection-button').click();
    });
    

    Id('study-selector-button').addEventListener('click', (evt)=>{

        toggleLoading(true);

        console.log('study-selector-button clicked');
        let study_name = Id('study-selector').selected()[0]['cell_text'];
        console.log('**Study name clicked:', study_name);
        
        
                let component = new CRMResultsComponent();//crm-results-element
                Id('results-charts-container').innerHTML = '';
                Id('results-charts-container').classList.remove('hidden');
                Id('results-charts-container').appendChild(component);
                Id('results-tab-button').click();

             


                /*debug*/
                const sampleData = {
  case_name: "TestModel1",
  data: [
    { INJECTOR: "I01", PRODUCER: "P1", ALLOCATION: 0.992909593, TAU: 0.349081711, TAUP: 49.99999996, PRODUCTIVITY: 0, Lo: 0, MODEL: "CRMP", R2: 0.991063231, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I02", PRODUCER: "P1", ALLOCATION: 0.474019881, TAU: 0.349081711, TAUP: 49.99999996, PRODUCTIVITY: 0, Lo: 0, MODEL: "CRMP", R2: 0.491063231, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I03", PRODUCER: "P1", ALLOCATION: 0.089225377, TAU: 0.349081711, TAUP: 49.99999996, PRODUCTIVITY: 0, Lo: 0, MODEL: "CRMP", R2: 0.991063231, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I04", PRODUCER: "P1", ALLOCATION: 0.217863424, TAU: 0.349081711, TAUP: 49.99999996, PRODUCTIVITY: 0, Lo: 0, MODEL: "CRMP", R2: 0.891063231, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I05", PRODUCER: "P1", ALLOCATION: 0.088541907, TAU: 0.349081711, TAUP: 49.99999996, PRODUCTIVITY: 0, Lo: 0, MODEL: "CRMP", R2: 0.991063231, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I01", PRODUCER: "P2", ALLOCATION: 0.013931884, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.6937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I02", PRODUCER: "P2", ALLOCATION: 0, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I03", PRODUCER: "P2", ALLOCATION: 0, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I04", PRODUCER: "P2", ALLOCATION: 0.099183015, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.737868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I05", PRODUCER: "P2", ALLOCATION: 0.102164928, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.3937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" }
    ,
    { INJECTOR: "I03", PRODUCER: "P4", ALLOCATION: 0.099183015, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.737868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I05", PRODUCER: "P5", ALLOCATION: 0.102164928, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.3937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" }
    ,
    { INJECTOR: "I04", PRODUCER: "P3", ALLOCATION: 0.099183015, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.8737868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" },
    { INJECTOR: "I05", PRODUCER: "P3", ALLOCATION: 0.102164928, TAU: 29.33999056, TAUP: 50, PRODUCTIVITY: 0, Lo: 0.959811962, MODEL: "CRMP", R2: 0.9937868466, SUBZONE: "SUBZONEUNIQUE", SIMULATION: "TestModel1" }
    
    
    // ... add the rest of the rows similarly
  ]
};
 
                component.setData(sampleData);

                component.addEventListener('close-clicked', ()=>{
                    Id('results-charts-container').innerHTML = '';
                    Id('results-charts-container').classList.add('hidden'); 
                    Id('field-tab-button').click();
                });


    });



</script>

<script id="load-empty-app">

    
    window.onload = function() {
        load_empty_app();
    };





</script>


<script id="floating-well-dialog-stuff">
    function openWellDetailDialog(wellName, chartData, tableData) {
      const dialog = document.getElementById("dell-detail-dialog");
      dialog.style.display = "flex";
  
      document.getElementById("dell-detail-dialog-header").textContent = wellName;
  
      Plotly.newPlot("dell-detail-dialog-chart", chartData, {
        margin: { t: 20 },
        responsive: true
      });
  
      const tbody = document.getElementById("dell-detail-dialog-table-body");
      tbody.innerHTML = "";
      tableData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.well}</td><td>${row.distance}</td><td>${row.type}</td>`;
        tbody.appendChild(tr);
      });
    }
  
    function closeWellDetailDialog() {
      document.getElementById("dell-detail-dialog").style.display = "none";
    }
  
    function showSampleDialog( well_details ) {
      const sampleChartData = [{
        x: ['2024-01', '2024-02', '2024-03', '2024-04'],
        y: [100, 120, 110, 130],
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Production'
      }];
  
      const sampleTableData = [
        { well: 'INJ-001', distance: 145, type: 'Injector' },
        { well: 'INJ-002', distance: 180, type: 'Injector' },
        { well: 'OBS-001', distance: 90, type: 'Observer' }
      ];
  
      openWellDetailDialog('WELL-ABC-101', sampleChartData, sampleTableData);
    }
  
    // Make the dialog draggable
    const dialog = document.getElementById("dell-detail-dialog");
    const header = document.getElementById("dell-detail-dialog-header");
    let offsetX = 0, offsetY = 0, isDragging = false;
  
    header.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - dialog.offsetLeft;
      offsetY = e.clientY - dialog.offsetTop;
      document.body.style.userSelect = 'none';
    });
  
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        dialog.style.left = `${e.clientX - offsetX}px`;
        dialog.style.top = `${e.clientY - offsetY}px`;
      }
    });
  
    document.addEventListener('mouseup', () => {
      isDragging = false;
      document.body.style.userSelect = '';
    });
</script>


<script id="window-controller">


    /*chart-exchange*/
    window.addEventListener('wells-names-selected-in-scatter-chart', (evt)=>{
        console.log('MAIN app: wells-names-selected-in-scatter-chart', evt.detail);
        let names = evt.detail.names;
        let key = 'Highlighted';
        
        let app_layout = Id('main-layout');
        let where = locations_chart_pane;
        let locs_container = app_layout.get_pane(where);
        highlightWellsInLocationsChart( locs_container, names, key );
    })

    /*chart-exchange*/
    window.addEventListener('wells-names-selected-in-locs-chart', (evt)=>{


      /*Delete the traces added sometime before.*/
      function deleteTracesInLegendGroup(plotDiv, legendGroup) {
            let tracesToDelete = [];
            plotDiv.data.forEach((trace, index) => {
                if (trace.legendgroup == legendGroup){
                    tracesToDelete.push(index);
                }
            });
            if(tracesToDelete.length < 1 )
                return new Promise((resolve, reject) => {resolve();});

            
            return Plotly.deleteTraces(plotDiv, tracesToDelete);
            
            
        }

      function highlightInWellChartsSelectedWells(names, data, groupName){

            if( names == undefined ) return;
            let traceIndex = -1;
            let markersAdded = 0;
            let points = [];

            for(let trace of data){
                
                console.log('checking one trace named ', trace.name);
                traceIndex = traceIndex + 1;
                let text = trace.text;
                if(text == undefined) continue;

                for( let name of names ){
                    
                    let index = text.indexOf(name);
                    if( index !=-1 ) {
                        console.log('found well name', name, 'in trace', traceIndex, ' point index', index, 'axes',trace.xaxis,trace.yaxis  ); 
                        points.push( {x:trace.x[index], y:trace.y[index],text:trace.text[index],xaxis:trace.xaxis,yaxis:trace.yaxis} )
                        markersAdded+=1;
                    }
                }
            }

            /*now lets create a new trace*/
            let traceMap = {};
            let counter = 0;
            let showlegend = true;

            for (let pt of points) {
                let key = `${pt.xaxis}-${pt.yaxis}`;
                if (!traceMap[key]) {

                    showlegend =  counter == 0 ? true : false
                    counter+=1;

                    traceMap[key] = {
                        x: [],
                        y: [],
                        text: [],
                        marker:{
                            size: highlighted_marker_size,
                            color: highlighted_marker_color
                        },
                        xaxis: pt.xaxis,
                        yaxis: pt.yaxis,
                        mode: 'markers+text',
                        type: 'scatter',
                        name: groupName,
                        legendgroup: groupName,
                        showlegend: showlegend
                    };
                }
                traceMap[key].x.push(pt.x);
                traceMap[key].y.push(pt.y);
                traceMap[key].text.push(pt.text);
            }

            // Convert grouped traces into an array
            let traces = Object.values(traceMap);
            console.log( 'tracess to add')
            console.log( traces )

            return Plotly.addTraces(plot, traces );//, plot.layout, plot.config);
        }


        console.log('**MAIN app: wells-names-selected-in-locs-chart', evt.detail);
        
        //can i highlight the wells in the wells selected in the charts in the locs chart? 
        let plot = Id('sector-plot-wells');

        if(plot!=undefined){
        
            let data = plot.data;
            let names = evt.detail.names;
            deleteTracesInLegendGroup(plot, 'Selected loc.'). then( ()=>{
            if( (names!=undefined) && (names.length > 0) ){
                highlightInWellChartsSelectedWells(names, data, 'Selected loc.');
            }
        });
        }

    })

    /*single-well detail*/
    window.addEventListener('well-name-selected', (evt)=>{
        
  
        let read_data = get_project_data_selection();
        read_data['well_name'] = evt.detail.name;
   

           

        toggleLoading(true);
        get_server('tell_me_everything_about_this_well','POST',JSON.stringify(read_data))
        .then( (resp) =>{
            console.log('tell_me_everything_about_this_well returned', resp);
            let data = resp.data;
            console.log( resp )
            console.log( data )

            const dialog = document.getElementById("dell-detail-dialog");
            dialog.style.display = "flex";
            document.getElementById("dell-detail-dialog-header").textContent = data['well_name'];

            const tbody = document.getElementById("dell-detail-dialog-table-body");
            tbody.innerHTML = "";
            data['neighbours'].forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${row.name}</td><td>${row.distance}</td><td>${row.type}</td>`;
                tbody.appendChild(tr);
            });

            let rates =  data['rates'];
            let dates =  data['rates']['dates'];
            const traces = [];
            for (const rate in rates) {
                if(rate=='dates')
                continue;

                traces.push({
                    x: dates, y: rates[rate], mode: 'lines', name: rate,
                    type: 'scatter'
                });
            }


            Plotly.newPlot("dell-detail-dialog-chart", traces, 
            { autosize:true, 
              x: {automargin:true},y: {automargin:true},
              //title: {'text':'Well rates', font: {size:20}},
              responsive: true
            },
            {responsive: true});
        
            //let chartData = data['chart_data'];
            //let tableData = data['table_data'];
            //showSampleDialog(33);

            toggleLoading(false);
        })
        .catch ((error) =>{
            console.log(error);alert('Error getting data for field data');
            toggleLoading(false);
        });



        //l/et well_details = 1120.00; 
        ///showSampleDialog( well_details );

    });


</script>

</body>
</html>
